#growse:$2y$05$8RDudDIlFqryyuakx/GMBuJsTmVJUDvb2rJXKMZQ/Pm75XFxkHZGG
---
# Builds, tests and publishes the output to the Play store internal track.
name: Build & Espresso Test

"on":
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: 17
      - name: Assemble
        run: ./gradlew assembleDebug assembleAndroidTest --no-daemon --scan
        timeout-minutes: 10

  espresso-test:
    name: "Espresso test"
    runs-on: self-hosted
    needs: build
    strategy:
      matrix:
        android-api: [33]
    steps:
      - name: Update path to add android tools
        run: |
          echo "/home/runner/android-sdk/platform-tools/" >> $GITHUB_PATH
          echo "/home/runner/android-sdk/cmdline-tools/latest/bin/" >> $GITHUB_PATH
      - name: Start adb
        run: adb start-server
      - name: Start emulator
        run: docker run -d -e "ADBKEY=$(cat ~/.android/adbkey)" --device /dev/kvm --publish 8554:8554/tcp -d --publish 5554:5554/tcp --publish 5555:5555/tcp growse/android-emulator-ci:30.1.2
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: 17
      - run: adb devices
      - name: wait for emulator boot
        run: adb wait-for-device && while [[ -z $(adb shell getprop sys.boot_completed) ]]; do echo "no boot yet" && sleep 1 ; done
        timeout-minutes: 10
      - name: Espresso test
        run: ./gradlew createDebugCoverageReport --no-daemon --scan
        timeout-minutes: 10
      - name: Upload connected test result artifact
        uses: actions/upload-artifact@v3
        with:
          name: espresso-test-reports-${{ matrix.android-api }}
          path: app/build/reports/androidTests/connected/
        if: always()
      - name: Upload connected test XML
        uses: actions/upload-artifact@v3
        with:
          name: espresso-test-xml-${{ matrix.android-api }}
          path: app/build/outputs/androidTest-results/connected/*.xml
      - name: Upload connected test coverage artifact
        uses: actions/upload-artifact@v3
        with:
          name: espresso-test-coverage-${{ matrix.android-api }}
          path: app/build/reports/coverage/androidTest/debug/
        if: always()
